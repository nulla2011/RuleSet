name: Update
on:
  schedule:
    - cron: '0 16 * * *'
  workflow_dispatch:       # ÂèØÈÄâÊâãÂä®Ëß¶Âèë

permissions:
  contents: write

jobs:
  fetch-and-patch:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    env:
        RULE_LIST: "AbemaTV Bahamut Niconico Spotify YouTube TikTok"
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: npm install
      - name: Fetch File
        run: |
          mkdir Temp
          cd Temp
          
          curl -O "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Proxy/Proxy_Classical.yaml"
          for name in $RULE_LIST; do
            curl -O "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/$name/$name.yaml"
          done
          curl -O "https://ruleset.skk.moe/Clash/non_ip/ai.txt"
      - name: Patch File
        run: |
          cd Script
          for name in $RULE_LIST; do
            node patch.mjs $name
          done
          node ai_sites.mjs
          node proxy.mjs
      - name: Commit & Push
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Bot Update"
          git push